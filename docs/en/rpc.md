# RPC Service

RPC services can have multiple protocols, and here we use the jsonrpc protocol as an example to illustrate the RPC server and client usage.

## Installation

```bash
composer require kuiper/jsonrpc:^0.8
```

## JSON RPC Server

### Service configuration
The JSONRPC service transport mode can use either HTTP protocol or TCP protocol.
Add a `kuiper\jsonrpc\config\JsonRpcServerConfiguration` service configuration in composer.json, for example:

```json
{
    "extra": {
        "kuiper": {
            "configuration": [
                "kuiper\\jsonrpc\\config\\JsonRpcServerConfiguration"
            ]
        }
    }
}
```

In `applicaton.server.ports` you need to configure the service transport protocol and listener:

```php
[
    'application' => [
        'server' => [
            'ports' => [
                env('SERVER_PORT', '8000') => [
                    'protocol' => 'http',
                    'listener' => 'jsonRpcHttpRequestListener'
                ]
            ]
        ]
    ] 
]
```

For the http transport protocol, the configured listener is `jsonRpcHttpRequestListener` and for the tcp transport protocol the listener is `jsonRpcTcpReceiveEventListener`.

### Service registration

Classes marked with the namespace scan annotation `kuiper\jsonrpc\attribute\JsonRpcService` in the project are registered as external jsonrpc service objects.
The service name can be specified by the `service` attribute value in the `JsonRpcService` annotation, and when not specified, it can be generated by the marked interface class name. The service name is generated by replacing the namespace separator with `.` by the interface name,
For example, the `app\service\UserService` service is named `app.service.UserService`.

In addition to using annotation tags, you can also register service objects by configuring 'application.jsonrpc.server.services', for example:

```php
<?php

return [
    'application' => [
        'jsonrpc' => [
            'server' => [
                'services' => [
                    UserService::class,
                    'calculator' => CalculatorService::class
                ]
            ]
        ]
    ]
];
```

The configuration key value for `application.jsonrpc.server.services` is the service name. value can be a time character or an array, and the array can contain the following configurations:
- Service service name
- The registration ID of the class service implementation class in the container
- Version service version number

### Configuration items

| Configuration Item | Environment variables | Description |
|---------------------------|---------------------------|---------------------------------|
| jsonrpc.server.log_file   | JSONRPC_SERVER_LOG_FILE   | Access log file name, default to jsonrpc-server.json|
| jsonrpc.server.log_params | JSONRPC_SERVER_LOG_PARAMS | Whether request parameters | are logged in the access log
| jsonrpc.server.out_params |                           | Whether to enable input parameter assignment |
| jsonrpc.server.middleware |                           | Middleware configuration |
| jsonrpc.server.services   |                           | Register for the service |

The `jsonrpc.server.out_params` configuration item is used to configure whether input parameter assignment is enabled. When our service statement contains input parameters that need to be assigned, for example:
```php
class RegistryService 
{
    public function getService(string $name, ?array &$result): int;
}
```
By setting `out_params` to true, you can combine the function return value and input parameters into an array as the result response.

## Client

### Client configuration

JSON RPC clients can be invoked through proxy objects.

Classes marked with the namespace scan annotation `\kuiper\jsonrpc\attribute\JsonRpcClient` in the project are registered as jsonrpc clients.
The service name can be specified by the parameter `service` in the `JsonRpcClient` annotation.

In addition to using annotation tags, you can also register the service object by configuring `application.jsonrpc.client.clients`, and configure the key value of the array to be the ID of the container registration. For example:

```php
<?php

return [
    'application' => [
        'jsonrpc' => [
            'client' => [
                'clients' => [
                    UserService::class,
                    'calculator' => CalculatorService::class,
                    'calculator2' => [
                       'class' => CalculatorService::class,
                       'endpoint' => 'http://localhost:8001'
                    ]
                ]
            ]
        ]
    ]
];
```

`application.jsonrpc.client.options` can be configured with default parameters by class name:

```php
[
    'application' => [
        'jsonrpc' => [
            'client'=> [
                'options' => [
                    FooService::class => [
                        'endpoint' => 'tcp://localhost:8000'
                    ]
                ]
            ]
        ]
    ]
];
```

Client configuration items include:
- endpoint Set the server address
- protocol service transport protocol, supports HTTP and TCP, default is HTTP
- service service name
- out_params Whether to enable input parameter assignment, refer to the 'out_params' configuration instructions on the server
- middleware sets up middleware
- Additional HTTP or TCP configuration parameters

Invoke the service:
```php
<?php
$result = $container->get(FooService::class)->foo();
```

### Configuration items

| Configuration Item | Environment variables | Description |
|--------------------------------|--------------------------------|--------------------------------|
| jsonrpc.client.log_file        | JSONRPC_CLIENT_LOG_FILE        | Request log file |
| jsonrpc.client.log_sample_rate | JSONRPC_CLIENT_LOG_SAMPLE_RATE | Log sampling rate, default is 1, set to 0 Do not log |
| jsonrpc.client.log_params      | JSONRPC_CLIENT_LOG_PARAMS      | Whether the request log records the request parameter |
| jsonrpc.client.protocol        | JSONRPC_CLIENT_PROTOCOL        | Service Transport Protocol, which supports HTTP and TCP, with the default value being http |
| jsonrpc.client.middleware      |                                | Middleware |
| jsonrpc.client.http_options    |                                | Set Public HTTP Configuration Parameters |
| jsonrpc.client.tcp_options     |                                | Set Public TCP Configuration Parameters |
| jsonrpc.client.clients         |                                | Register Client |
| jsonrpc.client.options         |                                | Client Configuration |

`http_options` configurable parameters refer to [HttpClient](http-client.md), `tcp_options` configurable parameters refer to swoole tcp configuration parameters.

## Implementation

RPC's server and client are implemented using interfaces similar to PSR-15 Http Handlers.
Request Processor Interface `kuiper\rpc\RpcRequestHandlerInterface` processing `kuiperrpcRpcRequestInterface` ,
and returns `kuiper\rpc\RpcResponseInterface`.
The middleware interface `kuiper\rpc\MiddlewareInterface` serves the same purpose as HTTP middleware and can be used to process RPC requests and responses.

The jsonrpc server-side middleware can be set through the configuration item `application.jsonrpc.server.middleware`.

The jsonrpc client middleware can be set through the configuration item `application.jsonrpc.client.middleware`, or it can be configured for each client class in
`application.jsonrpc.client.options`.

Next: [RPC Registry](rpc-registry.md)
