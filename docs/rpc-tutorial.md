# RPC Tutorial

RPC(Remote Procedure Call) 远程过程调用是分布式系统常见的通信方法。RPC 框架存在的目的是为了让分布式服务系统中不同服务之间的调用像本地调用一样简单。下面我们使用一个简单的例子演示如何使用 Kuiper 开发一个 RPC 服务。

RPC 的实现都包含传输协议和序列化协议两个部分。这里我们使用简单的 [JsonRPC](https://www.jsonrpc.org/specification) 作为序列化协议，使用 http 协议作为传输协议实现 jsonrpc 服务。

## 创建项目

我们还是使用项目模板创建项目：

```bash
composer create-project kuiper/skeleton:^0.2 app
```

这次我们选择第3项 JsonRPC Web 服务：

```
Choose server type: 
[1] Http Web Server
[2] JsonRPC Web Server
[3] JsonRPC TCP Server
[4] Tars HTTP Web Server
[5] Tars TCP RPC Server
Make your selection (1): 2
```


## 文件目录结构

生成项目目录结构如下：

```
.
|-- composer.json
|-- console
|-- .env
|-- resources
|   `-- serve.sh
|-- tars
|   |-- config.json
|   `-- servant
|       `-- hello.tars
`-- src
    |-- config.php
    |-- container.php
    |-- index.php
    |-- servant
    |   `-- HelloServant.php
    `-- application
        `-- HelloServantImpl.php
```

项目文件与 Web 项目基本相同。jsonrpc 服务通过 `#JsonRpcService` 注解标记：

```php
<?php

declare(strict_types=1);

/**
 * NOTE: This class is auto generated by Tars Generator (https://github.com/wenbinye/tars-generator).
 *
 * Do not edit the class manually.
 * Tars Generator version: 0.6
 */

namespace app\servant;

use kuiper\jsonrpc\attribute\JsonRpcService;

#[JsonRpcService(service: "HelloObj")]
interface HelloServant
{
    public function say(string $message): string;

}
```
这个文件是通过 `composer gen` 命令，根据 `tars/serant/hello.tars` 文件生成的。

再看 `application/HelloServantImpl.php"`
```
<?php

declare(strict_types=1);

namespace wenbinye\jsonrpchttpserver\application;

use kuiper\di\attribute\Service;
use wenbinye\jsonrpchttpserver\servant\HelloServant;

#[Service]
class HelloServantImpl implements HelloServant
{
    /**
     * {@inheritdoc}
     */
    public function say(string $message): string
    {
        return "hello $message";
    }
}
```

使用 `composer serve` 启动服务后，通过 cURL 命令来验证我们的服务：

```bash
$ curl -d '{"jsonrpc": "2.0", "id": 1, "method": "HelloObj.say", "params": ["kuiper"]}' localhost:7000
{"jsonrpc":"2.0","id":1,"result":"hello kuiper"}
```

## 客户端调用

我们通过新建另一个项目来调用启用的服务。

```bash
composer create-project kuiper/skeleton:^0.2 app2
```

选择第1项 Http Server 作为服务类型。添加依赖：

```bash
cd app2
composer require kuiper/rpc-client:^0.8 
```

新建文件 src/integration/HelloServant.php 如下：

```php
<?php

declare(strict_types=1);

namespace app2\integration;

use kuiper\jsonrpc\attribute\JsonRpcClient;

#[JsonRpcClient(service: "HelloObj")]
interface HelloServant
{
    public function say(string $message): string;

}
```

我们在 HelloService 上添加 `#kuiper\jsonrpc\attribute\JsonRpcClient` 注解，并设置注解的 service 属性为我们启动服务的服务名称。

在 `src/config.php` 中添加配置，设置服务调用地址：

```php
<?php

declare(strict_types=1);

use function kuiper\helper\env;

use app2\integration\HelloSerant;

return [
    'application' => [
        'jsonrpc' => [
            'client' => [
                'options' => [
                    HelloServant::class => [
                        'endpoint' => 'tcp://localhost:7000'
                    ]
                ],
            ]
        ]
    ],
];
```

最后我们写一个测试脚本 `test.php`，验证服务调用过程：

```php
<?php

require __DIR__ . '/vendor/autoload.php';

use kuiper\swoole\Application;
use app2\integration\HelloServant;

$service = Application::create()->getContainer()->get(HelloServant::class);
echo $service->say('kuiper'), "\n";
```

执行 `php test.php` 查看 RPC 调用结果：

```bash
$ php test.php
hello kuiper
```

下一节：[TARS Tutorial](tars-tutorial.md)
