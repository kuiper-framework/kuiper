# TARS Tutorial

[TARS](https://github.com/TarsCloud/Tars/blob/master/README.zh.md) 是腾讯开源的高性能RPC开发框架，集成服务发现、运维管理、服务监控等功能。TARS 官方提供的 PHP 库使用颇为繁琐，代码不好维护。Kuiper 框架在易用性方面作了很多工作，可以非常方便的开发 TARS RPC 服务。

## 创建项目

同样，我们使用项目模板创建项目：

```bash
composer create-project kuiper/skeleton app
```

服务类型选择第5项 Tars TCP RPC 服务：

```
Choose server type: 
[1] Http Web Server
[2] JsonRPC Web Server
[3] JsonRPC TCP Server
[4] Tars HTTP Web Server
[5] Tars TCP RPC Server
Make your selection (1): 5
```

## 文件目录结构

生成项目目录结构如下：

```
|-- composer.json
|-- config.conf
|-- config.conf.example
|-- console
|-- .env
|-- resources
|   `-- serve.sh
|-- src
|   |-- application
|   |   `-- HelloServantImpl.php
|   |-- config.php
|   |-- container.php
|   |-- index.php
|   `-- servant
|       `-- HelloServant.php
`-- tars
    `-- servant
        `-- hello.tars
```

与 jsonrpc 服务相比，我们多了一些文件。我们不再使用 `src/service` 目录作为服务接口目录，而是使用 servant 作为包名，在 `src/servant/HelloServant.php` 中声明接口。

```php
<?php

declare(strict_types=1);

/**
 * NOTE: This class is auto generated by Tars Generator (https://github.com/wenbinye/tars-generator).
 *
 * Do not edit the class manually.
 * Tars Generator version: 1.0
 */

namespace app\servant;

use kuiper\tars\annotation\TarsParameter;
use kuiper\tars\annotation\TarsReturnType;
use kuiper\tars\annotation\TarsServant;

/**
 * @TarsServant("HelloObj")
 */
interface HelloServant
{
    /**
     * @TarsParameter(name="message", type="string")
     * @TarsReturnType("string")
     *
     * @param string $message
     *
     * @return string
     */
    public function hello(string $message): string;
}
```

这个文件中使用了很多注解，如文件注释中指出的，这个文件是通过 [tars-generator](https://github.com/wenbinye/tars-generator) 这个工具生成的。
原文件为 `tars/servant/hello.tars` ：

```
module app
{
    interface Hello
    {
        string hello(string message);
    };
};
```

运行 `composer gen` 这个命令就能生成 `HelloServant.php` 这个文件。

## 服务实现

`src/application/HelloServantImpl.php` 是服务接口的实现，和普通的应用服务没有差别：

```php
<?php

declare(strict_types=1);

namespace app\application;

use app\servant\HelloServant;
use kuiper\di\annotation\Service;

/**
 * @Service
 */
class HelloServantImpl implements HelloServant
{
    /**
     * {@inheritdoc}
     */
    public function hello(string $message): string
    {
        return "hello $message";
    }
}
```

这里我们使用 `@kuiper\di\annotation\Service` 注解将服务实现注册到容器中。

TARS 应用并不依赖 tars 平台运行，使用 `composer serve` 也可以启动本地服务。本地服务和部署在 tars 平台上的应用一样，启动时需要指定配置文件，这个配置文件是 `config.conf` 文件。`config.conf` 默认情况和 `config.conf.example` 相同，但是不会提交到 git 仓库中。

## 客户端调用

当 TARS 应用部署到 tars 平台，会将服务地址注册到 tars 服务注册中心。而在本地执行时，缺少注册中心，需要通过服务配置指定服务地址。我们先通过这种方式演示如何调用 tars RPC。

同样我们新建另一个项目来调用本地服务。


```bash
composer create-project kuiper/skeleton app2
```

这次我们选择使用 Tars HTTP Server 演示如何调用 Tars RPC 服务：

```
Choose server type: 
[1] Http Web Server
[2] JsonRPC Web Server
[3] JsonRPC TCP Server
[4] Tars HTTP Web Server
[5] Tars TCP RPC Server
Make your selection (1): 4
```

在 tars 目录下添加代码生成配置文件 `tars/config.json`，用于指定服务名：

```json
{
    "client": {
        "servants": {
            "Hello": "app.demo.HelloObj"
        }
    }
}
```

将上面 Tars 服务的  `tars/servant/hello.tars` 复制到当前目录下 `tars/client/hello.tars`，并生成代码 ：

```bash
mkdir tars/client
cp ../app/tars/servant/hello.tars tars/client
composer gen
```

生成的代码在 `src/integration` 目录下，以 tars 文件中的 module 名字为命名空间。

在配置文件 `src/config.php` 中添加服务地址配置：

```php
<?php

declare(strict_types=1);

use app2\integration\app\HelloServant;

return [
    'application' => [
        // ... 其它配置
        'tars' => [
            'client' => [
                'options' => [
                    HelloServant::class => [
                        'endpoint' => 'app.demo.HelloObj@tcp -h localhost -p 7000'
                    ]
                ]
            ]
        ]
    ],
];
```

我们修改一下 `src/application/controller/IndexController.php` 加入调用服务的过程：

```php
<?php

declare(strict_types=1);

namespace wenbinye\app2\application\controller;

use kuiper\di\annotation\Controller;
use kuiper\web\AbstractController;
use kuiper\web\annotation\GetMapping;
use app2\integration\app\HelloServant;

/**
 * @Controller
 */
class IndexController extends AbstractController
{
    /**
     * @Inject
     * @var HelloServant
     */
    private $helloServant;

    /**
     * @GetMapping("/")
     */
    public function index(): void
    {
        $this->getResponse()->getBody()->write($this->helloServant->hello("kuiper"));
    }
}
```

使用 `composer serve` 启动服务，并使用 `curl -v http://localhost:8000` 验证服务调用是否成功。

## 服务部署

TARS 平台的搭建和应用创建过程不在本文档赘述，参考官方文档，建议通过 docker 搭建。

在应用开发完成后，使用 `composer pack` 命令打包代码，将代码上传到 tars 平台即可完成服务部署。
建议在打包前使用 `composer install --no-dev` 命令减少代码包大小。
